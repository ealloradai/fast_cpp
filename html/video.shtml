 

var stillImagePath;
var fullImagePath = "";
var use_activex = 0;
var use_java = 0;
var use_spush = 0;
var use_flash = 0;
var use_still = 0;
var use_quicktime = 0;
var rotation_in_url = "";
var rotation_in_parhand = "180";
var resolution_in_url = "";
var resolution_in_parhand = "640x480";
var streamprofile_in_url = "";
var recording = "";
var zoom_fact = "";
var ShowAMCToolbar = "";

function IPAddress(path)
{
  var str = path.slice(7);
  var anArray = str.split('/');

  if (anArray[0].split(":").length > 1)
  {
    anArray[0] = "[" + anArray[0] + "]";
  }
  return anArray[0];
}

function video(imagepath)
{
  var resolution = 0;
  var width = 0;
  var height = 0;
  var isTilted = false;



  if (imagepath.indexOf("rotation=") != -1) {
    if (rotation_in_url == "90" || rotation_in_url == "270") {
      isTilted = true;
    } else if (rotation_in_url == "" && (rotation_in_parhand == "90" || rotation_in_parhand == "270")) {
      isTilted = true;
    }
  } else {
    if (rotation_in_parhand == "90" || rotation_in_parhand == "270") {
      isTilted = true;
    }
  }

  if (imagepath.indexOf("resolution=") != -1) {
    var resStart = imagepath.indexOf("resolution=")
    var resStop = imagepath.indexOf("&", resStart)
    if (resStop == -1) resStop = imagepath.length
    resolution = imagepath.substring(resStart + 11, resStop);
    if (resolution.indexOf('x') != -1) {
      width = parseInt(resolution.substring(0, resolution.indexOf('x')), 10);
      height = parseInt(resolution.slice((resolution.indexOf('x') + 1)), 10);
    }
  }

  if (!(width > 0 && height > 0)) {
    if (typeof(img_width) == "number" && typeof(img_height) == "number" && img_width > 0 && img_height > 0) {
      width = img_width;
      height = img_height;
      resolution = width + 'x' + height;
    } else if ((imagepath.indexOf("mpeg4") != -1) || (imagepath.indexOf("h264") != -1)) {
      width = parseInt("640", 10);
      height = parseInt("480", 10);
      resolution = width + 'x' + height;
    } else {
      width = parseInt("640", 10);
      height = parseInt("480", 10);
      resolution = width + 'x' + height;
    }
  }

  var doubleLines = false;
  var imagepath_has_resolution = (imagepath.indexOf("resolution=") >= 0);
  var imagepath_uses_2cif = (imagepath.indexOf("resolution=2CIFEXP") == -1 && imagepath.indexOf("resolution=2CIF") != -1);

  var streamprofile_has_resolution = false;
  var streamprofile_uses_2cif = false;
  if ((imagepath.indexOf("streamprofile=") != -1))
  {
    var videoFormat = document.getElementsByName("videoFormat")[0];
    if (videoFormat)
    {
      var streamprofile_nr = videoFormat.options[videoFormat.selectedIndex].value;
      var streamprofile_param = document.getElementsByName("root_StreamProfile_S" + streamprofile_nr + "_Parameters")[0];
      if (streamprofile_param)
      {
        streamprofile_has_resolution = (streamprofile_param.value.indexOf("resolution=") >= 0);
        streamprofile_uses_2cif = (streamprofile_param.value.indexOf("resolution=2CIFEXP") == -1 && streamprofile_param.value.indexOf("resolution=2CIF") != -1);
      }
    }
  }

  if (recording != "yes" && resolution_in_url == "" && streamprofile_in_url == "" && !imagepath_has_resolution && !streamprofile_has_resolution && resolution_in_parhand.toLowerCase() == "2cif"
      || imagepath_uses_2cif || streamprofile_uses_2cif)
  {
    doubleLines = true;
  }

  if (width > height)
  {
    height *= (doubleLines ? 2 : 1);
    if (isTilted)
    {
      var tmp = width;
      width = height;
      height = tmp;
    }
  }
  else
  {
    width *= (doubleLines ? 2 : 1);
  }
  resolution = width + 'x' + height;

  var width_height = 'width="' + width + '" height="' + height + '"';
  var viewer = "still";

  if ((navigator.appName == "Microsoft Internet Explorer") && (navigator.platform != "MacPPC") && (navigator.platform != "Mac68k")) {
    viewer = "";
  } else {
    viewer = "";
  }

  if (viewer.indexOf("activex") != -1) {
    use_activex = 1;
  }
  if (viewer.indexOf("spush") != -1) {
    use_spush = 1;
  }
  if (viewer.indexOf("flash") != -1) {
    use_flash = 1;
  }
  if (viewer.indexOf("quicktime") != -1) {
    use_quicktime = 1;
  }
  if ((imagepath.indexOf("videocodec=mpeg4") != -1) || (imagepath.indexOf("videocodec=h264") != -1))
  {
    if ((navigator.appName == "Microsoft Internet Explorer") && (navigator.platform != "MacPPC") && (navigator.platform != "Mac68k")) {
        use_quicktime = 0;
        use_activex = 1;
    } else {
      use_quicktime = 1;
      use_spush = 0;
      use_still = 0;
    }
  } else {
    if ((navigator.appName == "Microsoft Internet Explorer") && (navigator.platform != "MacPPC") && (navigator.platform != "Mac68k")) {
        use_quicktime = 0;
        use_activex = 1;
    } else {
      use_quicktime = 0;
      use_spush = 1;
      use_still = 0;
    }
  }
  if (viewer.indexOf("java") != -1) {
    if ((imagepath.indexOf("mpeg4") == -1) && (imagepath.indexOf("h264") == -1)) {
      use_java = 1;
      use_activex = 0;
      use_spush = 0;
      use_flash = 0;
      use_still = 0;
      use_quicktime = 0;
    }
  }
  if ((viewer.indexOf("still") != -1) || !(use_activex || use_spush || use_flash || use_java || use_quicktime)) {
    if ((imagepath.indexOf("mpeg4") == -1) && (imagepath.indexOf("h264") == -1)) {
      use_still = 1;
      use_quicktime = 0;
      use_spush = 0;
      use_activex = 0;
    } else {
      if ((navigator.appName == "Microsoft Internet Explorer") && (navigator.platform != "MacPPC") && (navigator.platform != "Mac68k")) {
        use_activex = 1;
      } else {
        use_quicktime = 1;
      }
    }
  }
  var agent = navigator.userAgent.toLowerCase();
  if (agent.indexOf("applewebkit/") != -1) {
    var pos = agent.indexOf("applewebkit/") + 12
    var webKitVersion = parseInt(agent.substring(pos, agent.indexOf(" ", pos)), 10)
    if ((use_spush) && (webKitVersion < 416)) {
      use_java = 1;
      use_spush = 0;
    }
  }
  if (use_activex) {
    if (ShowAMCToolbar == "yes")
      height = height + 54;
    var notAuthorizedText = "The installation of the MPEG-4 Decoder has been disabled. Contact the Administrator of this $glob_prodName$.";
    var notAuthorizedH264Text = "The installation of the H.264 Decoder has been disabled. Contact the Administrator of this $glob_prodName$.";
    var authorizedText = "Click here to install or upgrade the MPEG-4 Decoder.";
    var authorizedH264Text = "Click here to install or upgrade the H.264 Decoder.";
    var installDecoderText1 = "<b>MPEG-4 Decoder</b>, which enables streaming video in Microsoft Internet Explorer, has not been installed or could not be registered on this computer.";
    var installDecoderH264Text1 = "<b>The H.264 Decoder</b>, which enables streaming video in Microsoft Internet Explorer, has not been installed or could not be registered on this computer.";
    var installDecoderText2 = "To <a href=\"javascript:launch('/incl/license.shtml')\">install or upgrade</a> the MPEG-4 Decoder, you must have Administration rights on this computer and you must answer Yes <br>when asked if you wish to allow the installation. $glob_prodName$ can also be configured to show still images.";
    var installDecoderH264Text2 = "To <a href=\"javascript:launch('/incl/license_h264.shtml')\">install or upgrade</a> the H.264 Decoder, you must have Administration rights on this computer and you must answer Yes <br>when asked if you wish to allow the installation. $glob_prodName$ can also be configured to show still images.";
    var notAuthorizedAacText = "The installation of the AAC Decoder has been disabled. Contact the Administrator of this $glob_prodName$.";
    var authorizedAacText = "Click here to install or upgrade the AAC Decoder.";
    var installAacDecoderText1 = "<b>AAC Decoder</b>, which enables streaming AAC audio in Microsoft Internet Explorer, has not been installed or could not be registered on this computer.";
    var installAacDecoderText2 = "To <a href=\"javascript:launch('/incl/aac_license.shtml')\">install or upgrade</a> the AAC Decoder, you must have Administration rights on this computer and you must answer Yes <br>when asked if you wish to allow the installation.";

    var installText1 = "which enables streaming";
    var videoText = "video";
    var audioText = "audio";
    var installText2 = "in Microsoft Internet Explorer, has not been installed<br>or could not be registered on this computer.";
    var installText3 = "To install or upgrade the";
    var installText4 = ", you must have Administration rights on this computer and you must answer Yes <br>when asked if you wish to allow the installation.<br>Click on the yellow banner to begin the installation. If the banner is not visible, turn off pop-up blockers<br>from the Tools menu in Microsoft Internet Explorer.<br>$glob_prodName$ can also be configured to show still images.";
    document.write("<center>");
    DrawAMC("", "AXIS Media Control", height, width, imagepath, "DE625294-70E6-45ED-B895-CFFA13AEB044", "AMC.cab", "5&#44;9&#44;9&#44;0", ShowAMCToolbar, "no", "", "1", "", "", "", "", "", "554", "", installText1, videoText, installText2, installText3, installText4, "", (recording == "yes" ? "recording" : zoom_fact), "", "");

    if (imagepath.indexOf("h264") != -1) {
      InstallDecoder("", "H.264 Decoder", "7340F0E4-AEDA-47C6-8971-9DB314030BD7", "NotFound.cab", "2&#44;4&#44;1&#44;0",
""
, notAuthorizedH264Text, authorizedH264Text, installDecoderH264Text1, installDecoderH264Text2);
    }
  InstallFilter("", "File Writer", "24E31783-87EF-4765-A430-4C8A983ACE16", "2&#44;0&#44;14&#44;0", "AMC.cab", installText1, videoText, installText2, installText3, installText4);
if ( String( getHost(imagepath) ).indexOf("rtsp") != -1 ) {
        InstallFilter("", "Overlay Mixer Filter", "03825DEB-4BC8-4344-ACF7-EC390A8A5A21", "1&#44;1&#44;3&#44;0", "AMC.cab", installText1, videoText, installText2, installText3, installText4);
      InstallFilter("", "MPEG RTP Reader", "67B1A88A-B5D2-48B1-BF93-EB74D6FCB077", "2&#44;8&#44;6&#44;0", "AMC.cab", installText1, videoText, installText2, installText3, installText4);
      InstallFilter("", "Image Notify Component", "0173EEF5-1FDE-479C-9F24-34C3CB0B3243", "1&#44;2&#44;1&#44;0", "AMC.cab", installText1, videoText, installText2, installText3, installText4);
}

    document.write("</center>");
    document.write("<br>");
  }

  if (use_spush) {
   if (recording != "yes" && ShowAMCToolbar == "yes")
   {
    document.write('<table cellspacing=0 cellpadding=0 border=0 style="min-width:260"><tr><td colspan="3" align="center">');
   }
      var output = '<img id="stream" SRC="' + imagepath + '" ' + width_height;
      var view_NoImageTxt = "If no image is displayed, there might be too many viewers, or the browser configuration may have to be changed. See help for detailed instructions on how to do this."
      output += ' border=0 ALT="' + view_NoImageTxt + '">';
    output += '<br>';
    <script type='text/javascript' language="JavaScript">
// 	var img = new Image();
	var canvas = document.getElementById("Canvas");
	var ctx = canvas.getContext("2d");
	if(!canvas)
	  document.write("Ciao");
	ctx.fillStyle = "rgb(200,0,0)";
	ctx.fillRect(10, 10, 100, 50);
// 	img.src = "' + imagepath + '";
// 	cxt.drawImage(img, 0, 0);
    </script>
	
<!--     document.write(output); -->
    
    if (recording != "yes" && ShowAMCToolbar == "yes")
    {
      if (document.getElementById("stream"))
        fullImagePath = document.getElementById("stream").src
      else
        fullImagePath = "";
      stillImagePath = "/jpg/1/image.jpg"
      if (imagepath.indexOf("/axis-cgi/mjpg/video.cgi") != -1) {
        var searchStr = "/axis-cgi/mjpg/video.cgi"
        var replaceStr = "/jpg/1/image.jpg"
        var re = new RegExp(searchStr , "g")
        stillImagePath = imagepath.replace(re, replaceStr)
      }

      document.write('</td></tr>');


        document.write('<tr><td colspan="3" align="center" style="white-space:nowrap">' );

        document.write('<div class="cornerVideoBox"><div class="content">');
        document.write('<table cellspacing=0 border=0 width="100%" id="videoItems" class="shownItems">');
        document.write('<tr height="32">');
        document.write("<td align=\"right\" width=\"40\"><a id=\"stopBtn\" href=\"javascript:void(0)\" onclick=\"stopStartStream('" + stillImagePath + "')\"><img src=\"/pics/stop_blue_button_27x27px.gif\" width=\"27\" height=\"27\" alt=\"Stop stream\" title=\"Stop stream\" border=\"0\" onmouseover=\"javascript:btnShiftCls( this, true )\" onmouseout=\"javascript:btnShiftCls( this, false )\" /></a>");
        document.write("<a id=\"playBtn\" style=\"display:none;\" href=\"javascript:void(0)\" onclick=\"stopStartStream('" + fullImagePath + "')\"><img src=\"/pics/play_blue_button_27x27px.gif\" width=\"27\" height=\"27\" alt=\"Start stream\" title=\"Start stream\" border=\"0\" onmouseover=\"javascript:btnShiftCls( this, true )\" onmouseout=\"javascript:btnShiftCls( this, false )\" /></a></td>");
        document.write("<td>&nbsp;</td></tr></table>");

        document.write('</div><div class="footerLeft"><div class="footerRight"></div></div></div>');


        document.write('</td></tr></table>');
    }
<!--	document.write('<div style="position: absolute; left: 20px; top: 30px; width: 1px; height: 1px; background-color: red;"></div>');
	document.write('<div style="position: absolute; left: 21px; top: 31px; width: 1px; height: 1px; background-color: red;"></div>');
	document.write('<div style="position: absolute; left: 22px; top: 32px; width: 1px; height: 1px; background-color: red;"></div>');
	document.write('<div style="position: absolute; left: 23px; top: 33px; width: 1px; height: 1px; background-color: red;"></div>');
	var offsetTrail = document.getElementById("stream");
	var offsetLeft = 0;
	var offsetTop = 0;
	    offsetLeft += offsetTrail.offsetLeft;
	    offsetTop += offsetTrail.offsetTop;
	var posx = offsetLeft + 20;
	var posy = offsetTop + 20;
	document.write('<div style="position: absolute; left: "+posx+"px; top: "+posy+"px; width: 1px; height: 1px; background-color: red;"></div>');-->
	
  }

  if (use_quicktime) {
    var DisplayWidth = width;
    var DisplayHeight = height + (ShowAMCToolbar == "yes" ? 16 : 0 );
    var rtspPort = "554";
    if (imagepath.indexOf("://") == -1) {
      if (location.hostname.split(":").length > 1) {
        //IPv6
        var MediaURL = "rtsp://[" + location.hostname + "]:" + rtspPort + imagepath 
      } else {
        //IPv4
        var MediaURL = "rtsp://" + location.hostname + ":" + rtspPort + imagepath 
      }
    } else {
      var MediaURL = imagepath
    }

    var output = "";
    output  = '<OBJECT CLASSID="clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B" width=' + DisplayWidth + ' height=' + DisplayHeight + ' CODEBASE="http://www.apple.com/qtactivex/qtplugin.cab">';
    output += '<param name="src" value="/view/AxisMoviePoster.mov">';
    output += '<param name="autoplay" value="true">';
    output += '<param name="controller" value="' + (ShowAMCToolbar == "yes" ? true : false) + '">';
    output += '<param name="qtsrc" value="' + MediaURL + '">';
    output += '<embed src="/view/AxisMoviePoster.mov" width=' + DisplayWidth + ' height=' + DisplayHeight + ' qtsrc="' + MediaURL + '" autoplay="true" controller="' + (ShowAMCToolbar == "yes" ? true : false) + '" target="myself" PLUGINSPAGE="http://www.apple.com/quicktime/download/"></embed>';
    output += '</OBJECT>';
    document.write(output);
  }

  if (use_flash) {
    var view_NeedFlashPluginTxt = "You need a Shockwave Flash plugin, get it from:"
    document.write('<EMBED src="/axis-cgi/mjpg/video.swf?resolution=' + resolution +'&camera=1" ' +
    'quality=high bgcolor=#000000 ' + width_height +
    ' TYPE="application/x-shockwave-flash" swLiveConnect=TRUE' +
    ' PLUGINSPAGE="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash">' +
    '</EMBED>' +
    '<NOEMBED>' + view_NeedFlashPluginTxt +
    '<a href="http://www.macromedia.com/shockwave/download/">Macromedia</a>.' +
    '</NOEMBED><br>');
  }

  if (use_java) {
      if (resolution.indexOf("x") != 0 && isTilted)
      {
        var tmpW = parseInt(resolution.split("x")[0], 10);
        var tmpH = parseInt(resolution.split("x")[1], 10);
        if (tmpW < tmpH)
        {
          resolution = tmpH + "x" + tmpW;
        }
      }
    var playerWidth = width;
    var playerHeight = height;
    if (ShowAMCToolbar == "yes")
    {
      if (playerWidth < 300)
        playerWidth = 300;
      playerHeight += 105;
    }

    if (imagepath.indexOf("http") != -1) {
      var addrEnd = imagepath.indexOf("/", 8);
      var addr = imagepath;
    } else {
      var addr = "";
    }
    //init AMA applet
    document.write('<OBJECT name="AMA" codeBase="/java/ama" archive="ama.jar" code="ama.MediaApplet" codetype="application/x-java-applet;version=1.4" type="application/x-java-applet;version=1.4" width="' + playerWidth + '" height="' + playerHeight + '">');
    document.write('<PARAM NAME="name" VALUE="AMA">');
    document.write('<PARAM NAME="codebase" VALUE="/java/ama">');
    document.write('<PARAM NAME="archive" VALUE="ama.jar">');
    document.write('<PARAM NAME="code" VALUE="ama.MediaApplet">');
    document.write('<PARAM NAME="codetype" VALUE="application/x-java-applet;version=1.4">');
    document.write('<PARAM NAME="type" VALUE="application/x-java-applet;version=1.4">');
    document.write('<PARAM NAME="mayscript" VALUE="false">');
    document.write('<PARAM NAME="ama_cgi-path" VALUE="axis-cgi">');
    document.write('<PARAM NAME="cache_archive" VALUE="ama.jar">');
    document.write('<PARAM NAME="cache_version" VALUE="1.1.9.0">');
    document.write('<PARAM NAME="ama_plugins" VALUE="">');
  var img_opts = "";
  if (imagepath.indexOf("?") > 0) {
    img_opts = imagepath.substring(imagepath.indexOf("?"));
    imagepath = imagepath.substring(0, imagepath.indexOf("?"));
  }
  if (img_opts.indexOf("camera=") == -1)
    img_opts += (img_opts.length > 0 ? "&" : "?") + "camera=1";

    if (img_opts.indexOf("resolution=") == -1)
      img_opts += (img_opts.length > 0 ? "&" : "?") + "resolution=" + resolution;

  if (rotation_in_parhand != "" && img_opts.indexOf("rotation=") == -1)
    img_opts += (img_opts.length > 0 ? "&" : "?") + "rotation=" + rotation_in_parhand;

  document.write('<PARAM NAME="ama_url" VALUE="' + imagepath + img_opts + '">');
    document.write("Your browser does not support Java")
    document.write('</OBJECT><br>');
  }

  if (use_still) {
    var picturepath;
    var tmpAddress = imagepath.match(/\/\/(.+?)\//g);

    if (tmpAddress == null)
      tmpAddress = imagepath.match(/(.+?)\//g);

    if (imagepath.charAt(0) == '/' || tmpAddress == null)
      picturepath = "/jpg/1/image.jpg";
    else
      picturepath = document.location.protocol + "//" + tmpAddress + "/jpg/1/image.jpg";

    document.write('<img SRC="' + picturepath + '" border=0 ' + width_height +'><br>');
  }


}

function stopStartStream(path)
{
  try {
    var orgPath = path;
    theDate = new Date();
    if (path.indexOf("?") != -1)
      path += "&"
    else
      path += "?"
    path += "timestamp=" + theDate.getTime()
    if (use_spush) {
      if (recording != "yes")
        stopStartBtnShift( orgPath );
      document.getElementById("stream").src = path;
    } else if (use_activex) {
      document.Player.MediaURL = path;
    }
  }
  catch(e) {}
}


function stopStartBtnShift( orgPath )
{
  if( orgPath == stillImagePath )
  {
    document.getElementById("stopBtn").style.display = 'none';
    document.getElementById("playBtn").style.display = 'inline';
  }
  else
  {
    document.getElementById("stopBtn").style.display = 'inline';
    document.getElementById("playBtn").style.display = 'none';
  }
}

function btnShiftCls( btnEl, over )
{
  if( btnEl ){
    btnEl.className = ((over)?'hover':'');
  }
}

